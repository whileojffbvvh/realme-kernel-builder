name: Build Flashable Kernel ZIP

on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'å†…æ ¸åç§°'
        required: true
        default: MyKernel-RMX1901

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Set Kernel Name
      run: |
        echo "KERNEL_NAME=${{ github.event.inputs.kernel_name }}" >> $GITHUB_ENV

    - name: Checkout Kernel Source
      run: |
        git clone --depth=1 --branch lineage-18.0 https://github.com/SagarMakhar/android_kernel_realme_sdm710 android-kernel
        cd android-kernel && echo "âœ… å†…æ ¸æºç å·²å…‹éš†"

    - name: Patch Defconfig for Container Support
      working-directory: android-kernel
      run: |
        CONFIG_FILE="arch/arm64/configs/RMX1901_defconfig"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° $CONFIG_FILE"
          exit 1
        fi

        echo "" >> "$CONFIG_FILE"
        echo "# === å®¹å™¨æ”¯æŒé…ç½® ===" >> "$CONFIG_FILE"
        echo "CONFIG_NAMESPACES=y" >> "$CONFIG_FILE"
        echo "CONFIG_UTS_NS=y" >> "$CONFIG_FILE"
        echo "CONFIG_IPC_NS=y" >> "$CONFIG_FILE"
        echo "CONFIG_USER_NS=y" >> "$CONFIG_FILE"
        echo "CONFIG_PID_NS=y" >> "$CONFIG_FILE"
        echo "CONFIG_NET_NS=y" >> "$CONFIG_FILE"
        echo "CONFIG_CGROUPS=y" >> "$CONFIG_FILE"
        echo "CONFIG_CGROUP_MEMORY=y" >> "$CONFIG_FILE"
        echo "CONFIG_MEMCG=y" >> "$CONFIG_FILE"
        echo "CONFIG_MEMCG_SWAP=y" >> "$CONFIG_FILE"
        echo "CONFIG_OVERLAY_FS=y" >> "$CONFIG_FILE"
        echo "CONFIG_OVERLAY_FS_REDIRECT_DIR=y" >> "$CONFIG_FILE"
        echo "CONFIG_OVERLAY_FS_INDEX=y" >> "$CONFIG_FILE"
        echo "CONFIG_IKCONFIG=y" >> "$CONFIG_FILE"
        echo "CONFIG_IKCONFIG_PROC=y" >> "$CONFIG_FILE"
        echo "CONFIG_CHECKPOINT_RESTORE=y" >> "$CONFIG_FILE"
        echo "CONFIG_MODULES=y" >> "$CONFIG_FILE"
        echo "CONFIG_MODULE_UNLOAD=y" >> "$CONFIG_FILE"
        echo "CONFIG_BRIDGE_NETFILTER=y" >> "$CONFIG_FILE"
        echo "CONFIG_NF_CONNTRACK=y" >> "$CONFIG_FILE"
        echo "CONFIG_NF_DEFRAG_IPV4=y" >> "$CONFIG_FILE"
        echo "CONFIG_NF_DEFRAG_IPV6=y" >> "$CONFIG_FILE"
        echo "CONFIG_SECURITY_SELINUX=y" >> "$CONFIG_FILE"

        echo "âœ… æˆåŠŸæ³¨å…¥å®¹å™¨æ”¯æŒ"

    - name: Install Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y bc bison flex libssl-dev libelf-dev zip

    # ğŸ”¥ ç¼“å­˜å·¥å…·é“¾ï¼ˆæå¤§åŠ å¿«åç»­æ„å»ºï¼‰
    - name: Cache Toolchains
      uses: actions/cache@v4
      with:
        path: tc/
        key: toolchain-final-v7
        restore-keys: toolchain-final-

    # ğŸ’¥ ä¸‹è½½çº¯å‡€é¢„ç¼–è¯‘å·¥å…·é“¾ï¼ˆçœŸå® tar.gzï¼Œæ—  HTML æ±¡æŸ“ï¼‰
    - name: Download Toolchains
      run: |
        mkdir -p tc
        cd tc

        # å¦‚æœå·²æœ‰æœ‰æ•ˆæ–‡ä»¶ï¼Œè·³è¿‡ä¸‹è½½
        if [ -f "clang/bin/clang" ] && [ -x "gcc/bin/aarch64-linux-android-gcc" ]; then
          echo "ğŸ“¦ ç¼“å­˜å‘½ä¸­ï¼šä½¿ç”¨å·²æœ‰å·¥å…·é“¾"
        else
          echo "ğŸ”„ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£åœ¨ä¸‹è½½çº¯å‡€å·¥å…·é“¾..."

          TOOLCHAIN_URL="https://github.com/hanipcode/toolchain-release/releases/download/v1.0/clang-gcc-toolchain.tar.gz"
          # å¤‡ç”¨åœ°å€ï¼ˆå¦‚æœä¸»é“¾æ¥å¤±è´¥ï¼‰ï¼š
          # TOOLCHAIN_URL="https://ghproxy.com/https://github.com/hanipcode/toolchain-release/releases/download/v1.0/clang-gcc-toolchain.tar.gz"

          rm -f toolchain.tar.gz

          for i in {1..3}; do
            echo "ğŸ“¥ ç¬¬ $i æ¬¡å°è¯•ä¸‹è½½..."
            curl -L -# --fail \
              "$TOOLCHAIN_URL" \
              -o toolchain.tar.gz
            if [ $? -eq 0 ] && [ -s toolchain.tar.gz ]; then
              break
            fi
            rm -f toolchain.tar.gz
            sleep 10
          done

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [ ! -f "toolchain.tar.gz" ] || [ ! -s "toolchain.tar.gz" ]; then
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶æœªä¸‹è½½æˆ–ä¸ºç©º"
            ls -lh
            exit 1
          fi

          # å…³é”®æ£€æŸ¥ï¼šç¡®è®¤æ˜¯ gzip å‹ç¼©åŒ…ï¼Œä¸æ˜¯ HTML
          file toolchain.tar.gz
          if [[ "$(file toolchain.tar.gz)" != *"gzip"* ]]; then
            echo "âŒ æ£€æµ‹åˆ°éæ³•æ–‡ä»¶ç±»å‹ï¼å¯èƒ½æ˜¯ HTML é¡µé¢ã€‚"
            head -n 20 toolchain.tar.gz
            exit 1
          fi

          # è§£å‹
          echo "ğŸ“¦ æ­£åœ¨è§£å‹..."
          tar --warning=no-unknown-keyword -xzf toolchain.tar.gz -C . || {
            echo "âŒ è§£å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‹ç¼©åŒ…å®Œæ•´æ€§"
            exit 1
          }

          rm -f toolchain.tar.gz
          echo "âœ… å·¥å…·é“¾è§£å‹å®Œæˆ"
        fi

        # åˆ›å»ºç¬¦å·é“¾æ¥
        ln -sf $(pwd)/clang/bin/* .
        ln -sf $(pwd)/gcc/bin/* .

        # æ·»åŠ åˆ° PATH
        cd ..
        echo "PATH=$(pwd)/tc:$PATH" >> $GITHUB_ENV

        # éªŒè¯å®‰è£…
        if ! command -v tc/clang/bin/clang &> /dev/null; then
          echo "âŒ Clang æœªå®‰è£…ï¼"
          ls tc/clang/bin/ || echo "ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "ğŸ‰ Clang ç‰ˆæœ¬: $(tc/clang/bin/clang --version | head -n1)"

        if [ ! -x "tc/gcc/bin/aarch64-linux-android-gcc" ]; then
          echo "âŒ GCC ä¸å¯æ‰§è¡Œï¼"
          ls tc/gcc/bin/ || echo "GCC ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "ğŸ‰ GCC å·²å°±ç»ª"

        echo "âœ… æ‰€æœ‰å·¥å…·é“¾å‡†å¤‡å®Œæ¯•ï¼"

    - name: Build Kernel
      working-directory: android-kernel
      env:
        ARCH: arm64
        SUBARCH: arm64
        CROSS_COMPILE: aarch64-linux-android-
        CLANG_TRIPLE: aarch64-linux-gnu-
        CC: clang
      run: |
        make O=out RMX1901_defconfig
        echo "âœ… defconfig å·²ç”Ÿæˆ"
        
        echo "ğŸ”„ å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make O=out -j$(nproc) Image.gz-dtb dtbo.img
        
        cp out/Image.gz-dtb ${{ github.workspace }}/
        cp out/dtbo.img ${{ github.workspace }} || touch ${{ github.workspace }}/dtbo.img
        echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

    - name: Download AnyKernel3
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3
        cd AnyKernel3
        cp ${{ github.workspace }}/Image.gz-dtb zImage
        cp ${{ github.workspace }}/dtbo.img . 2>/dev/null || echo "âš ï¸ æ—  dtbo.img"
        
        sed -i 's|kernel.string=.*|kernel.string=Built with GitHub Actions|' anykernel.sh
        sed -i 's|do.devicecheck=1|do.devicecheck=1|' anykernel.sh
        echo 'device.name1=RMX1901' >> anykernel.sh
        echo 'device.name2=RMX1903' >> anykernel.sh
        sed -i 's|supported.versions=.*|supported.versions=11|' anykernel.sh
        
        echo "âœ… AnyKernel3 é…ç½®å®Œæˆ"

    - name: Create Flashable ZIP
      run: |
        cd AnyKernel3
        ZIP_NAME="${KERNEL_NAME:-MyKernel}-$(date +%Y%m%d).zip"
        ./anykernel.sh
        mv "$ZIP_NAME" ${{ github.workspace }}/
        echo "ZIP_PATH=${{ github.workspace }}/$ZIP_NAME" >> $GITHUB_ENV
        echo "ğŸ‰ ZIP åŒ…å·²ç”Ÿæˆ: $ZIP_NAME"

    - name: Upload ZIP to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flashable-kernel-zip
        path: ${{ env.ZIP_PATH }}
        retention-days: 14
